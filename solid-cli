#!/bin/bash

# ==========================================
#  SOLIDTIME CLI v10.0 (Clean UI & Hidden IDs)
# ==========================================

API_URL="https://app.solidtime.io/api/v1"
TOKEN="TU_API_KEY_AQUI"
CACHE_FILE="/tmp/solidtime_creds"

# Paleta de Colores (Dise√±o Elegante)
BOLD=$(tput bold)
DIM=$(tput dim)
GREEN=$(tput setaf 2)
RED=$(tput setaf 1)
BLUE=$(tput setaf 4)
CYAN=$(tput setaf 6)
MAGENTA=$(tput setaf 5)
WHITE=$(tput setaf 7)
RESET=$(tput sgr0)

# --- FUNCIONES INTERNAS ---

call_api() {
    local method=$1
    local endpoint=$2
    local data=$3
    
    if [ -z "$data" ]; then
        curl -sS -X "$method" "$API_URL$endpoint" \
        -H "Authorization: Bearer $TOKEN" \
        -H "Content-Type: application/json" \
        -H "Accept: application/json"
    else
        curl -sS -X "$method" "$API_URL$endpoint" \
        -H "Authorization: Bearer $TOKEN" \
        -H "Content-Type: application/json" \
        -H "Accept: application/json" \
        -d "$data"
    fi
}

get_ids() {
    if [ -f "$CACHE_FILE" ]; then
        IFS=":" read -r saved_org saved_member < "$CACHE_FILE"
        if [ -n "$saved_org" ] && [ -n "$saved_member" ]; then
            ORG_ID=$saved_org
            MEMBER_ID=$saved_member
            return
        fi
    fi
    response=$(call_api "GET" "/users/me/memberships")
    org_id_val=$(echo "$response" | jq -r '.data[0].organization.id')
    member_id_val=$(echo "$response" | jq -r '.data[0].id')
    
    if [ "$org_id_val" == "null" ] || [ -z "$member_id_val" ]; then
        echo "‚ùå Error de credenciales." >&2
        rm -f "$CACHE_FILE"
        exit 1
    fi
    echo "$org_id_val:$member_id_val" > "$CACHE_FILE"
    ORG_ID=$org_id_val
    MEMBER_ID=$member_id_val
}

format_time() {
    local total_seconds=$1
    printf "%02d:%02d:%02d" $((total_seconds/3600)) $((total_seconds%3600/60)) $((total_seconds%60))
}

format_duration_human() {
    local sec=$1
    if [ -z "$sec" ] || [ "$sec" == "null" ]; then echo "--"; return; fi
    printf "%dh %02dm" $((sec/3600)) $((sec%3600/60))
}

# --- LOG (REPORTE) ---
log_day() {
    get_ids
    today_start=$(date -u +"%Y-%m-%dT00:00:00Z")
    today_end=$(date -u +"%Y-%m-%dT23:59:59Z")

    echo "üîÑ Sincronizando..."
    
    # Mapa de Proyectos
    declare -A PROJECT_MAP
    projects_raw=$(call_api "GET" "/organizations/$ORG_ID/projects")
    while IFS="|" read -r pid pname; do
        PROJECT_MAP["$pid"]="$pname"
    done < <(echo "$projects_raw" | jq -r '.data[] | "\(.id)|\(.name)"')

    echo "üîÑ Cargando tiempos..."
    response=$(call_api "GET" "/organizations/$ORG_ID/time-entries?start=${today_start}&end=${today_end}&per_page=100")
    
    total_day_sec=$(echo "$response" | jq '[.data[].duration // 0] | add')
    total_day_fmt=$(format_duration_human "$total_day_sec")
    
    clear
    echo "${BOLD}üìÖ HOY $(date +"%d/%m")${RESET}  |  Total: ${GREEN}${BOLD}$total_day_fmt${RESET}"
    echo "${DIM}‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ${RESET}"

    count=$(echo "$response" | jq '.data | length')
    if [ "$count" -eq 0 ]; then echo "üò¥ Nada por aqu√≠ hoy."; exit 0; fi

    tmp_subtotals="/tmp/solid_subtotals"
    > "$tmp_subtotals"

    echo "$response" | jq -r '.data[] | "\(.start)|\(.end)|\(.duration//0)|\(.project_id)|\(.description // "")"' | 
    while IFS="|" read -r start_utc end_utc dur pid desc; do
        p_name="${PROJECT_MAP[$pid]}"
        if [ -z "$p_name" ] || [ "$p_name" == "null" ]; then p_name="Desconocido"; fi

        if [ "$end_utc" != "null" ]; then echo "$p_name|$dur" >> "$tmp_subtotals"; fi

        start_local=$(date -d "$start_utc" +"%H:%M" 2>/dev/null)
        if [ "$end_utc" == "null" ]; then
            dur_txt="${GREEN}‚ñ∂ ACTIVO${RESET}"; icon="‚ö°"
            echo "$p_name|0" >> "$tmp_subtotals"
        else
            dur_txt=$(format_duration_human "$dur"); icon="‚óè"
        fi
        if [ ${#desc} -gt 40 ]; then desc="${desc:0:39}‚Ä¶"; fi

        echo "${CYAN}$start_local${RESET} $icon ${BOLD}$dur_txt${RESET}"
        echo "  ${BLUE}üìÇ $p_name${RESET}"
        echo "  ${DIM}üìù $desc${RESET}"
        echo "" 
    done

    if [ -s "$tmp_subtotals" ]; then
        echo "${DIM}‚îÄ‚îÄ RESUMEN POR PROYECTO ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ${RESET}"
        awk -F"|" '{a[$1]+=$2} END {for (i in a) print i"|"a[i]}' "$tmp_subtotals" | sort | \
        while IFS="|" read -r name seconds; do
            fmt=$(printf "%dh %02dm" $((seconds/3600)) $((seconds%3600/60)))
            echo -e "${MAGENTA}‚ñ†${RESET} $name: ${BOLD}$fmt${RESET}"
        done
        echo ""
    fi
}

# --- MEN√ö SALIDA ---
exit_menu() {
    tput cnorm
    echo ""
    echo "${BOLD}üõë PAUSA${RESET}"
    echo "[Enter] Guardar  |  [d] Borrar  |  [c] Seguir"
    read -n 1 -s choice
    case "$choice" in
        d|D)
            echo -e "\n${RED}üóëÔ∏è Eliminado.${RESET}"
            call_api "DELETE" "/organizations/$ORG_ID/time-entries/$CURRENT_ENTRY_ID" > /dev/null
            exit 0 ;;
        c|C) return ;;
        *)
            echo -e "\n${GREEN}üíæ Guardado.${RESET}"
            end_time=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
            call_api "PUT" "/organizations/$ORG_ID/time-entries/$CURRENT_ENTRY_ID" "{\"end\": \"$end_time\"}" > /dev/null
            exit 0 ;;
    esac
}

# --- DASHBOARD DE INICIO (NUEVO DISE√ëO) ---
start_timer() {
    get_ids
    clear
    echo "üîÑ Conectando..."
    
    # 1. CARGAR PROYECTOS EN ARRAYS (OCULTAR IDs)
    projects_json=$(call_api "GET" "/organizations/$ORG_ID/projects")
    
    # Arrays para guardar datos
    p_ids=()
    p_names=()
    
    # Leer JSON linea por linea y llenar arrays
    while IFS="|" read -r pid pname; do
        p_ids+=("$pid")
        p_names+=("$pname")
    done < <(echo "$projects_json" | jq -r '.data[] | "\(.id)|\(.name)"')
    
    # MOSTRAR LISTA LIMPIA
    clear
    echo "${BOLD}üìÇ SELECCIONA UN PROYECTO:${RESET}"
    echo "${DIM}‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ${RESET}"
    
    # Loop para imprimir bonito
    i=0
    for name in "${p_names[@]}"; do
        index=$((i+1))
        # Formato: 1. Nombre (Color Blanco)
        echo " ${BLUE}${BOLD}$index.${RESET} $name"
        ((i++))
    done
    echo ""
    read -p "${BOLD}> N√∫mero: ${RESET}" p_choice
    
    # Validar y recuperar ID oculto
    if ! [[ "$p_choice" =~ ^[0-9]+$ ]] || [ "$p_choice" -lt 1 ] || [ "$p_choice" -gt "${#p_ids[@]}" ]; then
        echo "‚ùå Opci√≥n inv√°lida"; exit 1
    fi
    
    # Array start at 0, option at 1
    idx=$((p_choice-1))
    p_id="${p_ids[$idx]}"
    p_name="${p_names[$idx]}"
    
    # 2. CARGAR TAREAS (MISMA L√ìGICA)
    clear
    echo "üîÑ Buscando tareas en $p_name..."
    tasks_json=$(call_api "GET" "/organizations/$ORG_ID/tasks?project_id=$p_id")
    t_count=$(echo "$tasks_json" | jq '.data | length')
    
    t_id="null"
    
    if [ "$t_count" -gt 0 ]; then
        t_ids=()
        t_names=()
        
        while IFS="|" read -r tid tname; do
            t_ids+=("$tid")
            t_names+=("$tname")
        done < <(echo "$tasks_json" | jq -r '.data[] | "\(.id)|\(.name)"')
        
        clear
        echo "${BOLD}üìã TAREAS EN: ${BLUE}$p_name${RESET}"
        echo "${DIM}‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ${RESET}"
        
        j=0
        for name in "${t_names[@]}"; do
            index=$((j+1))
            echo " ${CYAN}${BOLD}$index.${RESET} $name"
            ((j++))
        done
        echo ""
        read -p "${BOLD}> N√∫mero (Enter = Ninguna): ${RESET}" t_choice
        
        if [ -n "$t_choice" ] && [[ "$t_choice" =~ ^[0-9]+$ ]] && [ "$t_choice" -ge 1 ] && [ "$t_choice" -le "${#t_ids[@]}" ]; then
            t_idx=$((t_choice-1))
            t_id="${t_ids[$t_idx]}"
        fi
    fi

    # 3. INPUT FINAL
    clear
    echo "${DIM}Proyecto:${RESET} ${BLUE}$p_name${RESET}"
    read -p "${BOLD}üìù Descripci√≥n:${RESET} " desc
    if [ -z "$desc" ]; then desc="Focus Time"; fi

    # INICIO TIMER
    start_iso=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
    
    json="{\"member_id\": \"$MEMBER_ID\", \"project_id\": \"$p_id\", \"description\": \"$desc\", \"start\": \"$start_iso\", \"billable\": false}"
    if [ "$t_id" != "null" ]; then
        json=$(echo "$json" | jq --arg tid "$t_id" '. + {task_id: $tid}')
    fi

    resp=$(call_api "POST" "/organizations/$ORG_ID/time-entries" "$json")
    CURRENT_ENTRY_ID=$(echo "$resp" | jq -r '.data.id')
    
    if [ "$CURRENT_ENTRY_ID" == "null" ]; then echo "‚ùå Error al iniciar"; exit 1; fi

    # --- LOOP DASHBOARD ---
    start_sec=$(date +%s)
    tput civis
    trap 'exit_menu' SIGINT

    while true; do
        curr_sec=$(date +%s)
        elapsed=$((curr_sec - start_sec))
        cols=$(tput cols)
        max_len=$((cols - 4))
        if [ "$max_len" -lt 10 ]; then max_len=10; fi

        p_show=${p_name:0:$max_len}
        d_show=${desc:0:$max_len}

        clear
        echo ""
        echo " ${GREEN}‚óè${RESET} ${BOLD}FOCUS MODE${RESET}"
        echo " ${DIM}‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ${RESET}"
        echo " ${BOLD}$(format_time $elapsed)${RESET}"
        echo ""
        echo " ${BLUE}üìÇ $p_show${RESET}"
        echo " ${RESET}üìù $d_show${RESET}"
        echo ""
        echo " ${DIM}[Ctrl+C] Parar${RESET}"
        sleep 1
    done
}

case "$1" in
    start) start_timer ;;
    log) log_day ;;
    *) echo "Uso: solid {start|log}" ;;
esac
